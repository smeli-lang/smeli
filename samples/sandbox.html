<!DOCTYPE html>
<html>
  <head>
    <title>Hello Smeli!</title>
    <script src="../packages/smeli-core/dist/smeli-core.umd.js"></script>
    <script src="../packages/smeli-plugin-ui/dist/smeli-plugin-ui.umd.js"></script>
    <script>
      window.onload = () => {
        const textArea = document.querySelector("#code");
        const scopeView = document.querySelector("#scope");
        const messageView = document.querySelector("#messages");
        const previewContainer = document.querySelector("#preview");

        function escapeMarkup(str) {
          return str.replace("<", "&lt;").replace(">", "&gt;");
        }

        function enumerateBindings(scope) {
          const names = new Set();
          while (scope) {
            for (let name of scope.bindings.keys()) {
              names.add(name);
            }
            scope = scope.prefix;
          }
          return [...names];
        }

        function printScope(scope, indent) {
          let str = "";
          for (let name of enumerateBindings(scope)) {
            try {
              const value = scope.evaluate(name);
              str += "  ".repeat(indent);
              if (value.type() === smeli.ScopeType) {
                const childContent = printScope(value, indent + 1);
                str +=
                  `${name} = {<br />${childContent}` +
                  "  ".repeat(indent) +
                  "}<br />";
              } else {
                const type = value.type();
                const valueString = escapeMarkup(type.__str__(value));
                const typeString = escapeMarkup(type.__name__());
                str += `${name} = ${valueString} [${typeString}] <br />`;
              }
            } catch (e) {
              str +=
                "  ".repeat(indent) +
                `<span style="color: #d44">${name} - ${e.message}</span><br />`;
            }
          }

          return str;
        }

        function printMessages(messages) {
          return messages
            .map(message => `line ${message.line}: ${message.message}`)
            .join("<br />");
        }

        function reload() {
          const code = textArea.value;
          const engine = smeli.load(code, [
            smeliUi.load({ container: previewContainer })
          ]);

          try {
            const globalScope = engine.step(engine.rootStatements.length);
            scopeView.innerHTML = printScope(globalScope, 0);
            messageView.innerHTML = printMessages(engine.messages);
          } catch (e) {
            scopeView.innerHTML = "";
            messageView.innerHTML = `Runtime error: ${e.message}`;
          }
        }

        textArea.oninput = reload;
        reload();
      };
    </script>
  </head>
  <body
    style="margin: 0; padding: 0; display: flex; flex-direction: row; min-height: 100vh; align-items: stretch; font-family: Consolas;"
  >
    <div style="flex: 1; display: flex; flex-direction: column;">
      <textarea
        id="code"
        wrap="off"
        style="flex: 1; resize: none; overflow: auto; color: #fff; background-color: #444; border: none; border-left: 10px solid #4a4a5e; font-size: large; margin: 0;"
      >
plop: {
  a: 42
  b: a + 4
}

#>> same
plop.a: 42
plop.b: plop.a + 4

c: plop.a + plop.b

plop.a: 12

plop: {
  a: -10
  b: -20
}

plop.a: 120

# other scope
a: 42
b: a - 30

# lambda function tests
constant: 42

# multiple args
f: x, y => x + y + constant
v: f(10, 20)

# currying
g: x => y => x + y + constant
v2: g(10)
v3: v2(20)

# higher-order function
h: fn => fn(constant)
v4: h(x => x - 30)
</textarea
      >
      <div
        id="messages"
        style="background-color: #222; color: #f55; padding: 20px;"
      ></div>
    </div>
    <div style="flex: 1; display: flex; flex-direction: column;">
      <pre
        id="scope"
        style="flex: 1; background-color:#ddd; padding: 20px; margin: 0; font-family: Consolas"
      ></pre>
      <div
        id="preview"
        style="background-color: #fff; color: #222; flex: 1;"
      ></div>
    </div>
  </body>
</html>
